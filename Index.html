<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gerador de Holerite — Etapa 1</title>
  <style>
    body{font-family:Inter, Arial, Helvetica, sans-serif; background:#f3f4f6; padding:20px}
    .card{max-width:1100px;margin:18px auto;background:#fff;border-radius:12px;padding:18px;box-shadow:0 6px 20px rgba(0,0,0,.06)}
    h1{margin:0 0 12px 0}
    .grid{display:grid;gap:10px}
    .grid-2{grid-template-columns:1fr 1fr}
    .grid-3{grid-template-columns:1fr 1fr 1fr}
    label{display:block;font-size:13px;color:#111;margin-bottom:6px}
    input[type="text"], input[type="number"], input[type="date"], select {
      width:100%;padding:8px;border:1px solid #d1d5db;border-radius:8px;font-size:14px
    }
    .row-actions{display:flex;gap:8px;align-items:center}
    button{padding:10px 14px;border-radius:8px;border:0;background:#0ea5e9;color:#fff;font-weight:700;cursor:pointer}
    button.ghost{background:#fff;color:#111;border:1px solid #e5e7eb}
    table{width:100%;border-collapse:collapse}
    th, td{padding:6px 8px;border:1px solid #e6e7eb;font-size:13px}
    .small{font-size:12px;color:#374151}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
    .checkbox{display:flex;align-items:center;gap:6px;font-size:13px}
  </style>
</head>
<body>
  <div class="card">
    <h1>Gerador de Holerite — Etapa 1</h1>

    <section style="margin-bottom:14px">
      <h3 style="margin:0 0 8px 0">Dados do Empregador</h3>
      <div class="grid grid-2">
        <div>
          <label>Nome do Empregador</label>
          <input id="emp_nome" type="text" value="ERLI CANDIDO CEI">
        </div>
        <div>
          <label>CEI / CNPJ</label>
          <input id="emp_cei" type="text" value="512.058.2574/86">
        </div>
      </div>
    </section>

    <section style="margin-bottom:14px">
      <h3 style="margin:0 0 8px 0">Dados do Funcionário</h3>
      <div class="grid grid-3">
        <div>
          <label>Nome do Funcionário</label>
          <input id="func_nome" type="text" value="CRISTIANO GERALDO LOPES">
        </div>
        <div>
          <label>CPF</label>
          <input id="func_cpf" type="text" value="116.900.966-24">
        </div>
        <div>
          <label>Função</label>
          <input id="funcao" type="text" value="AUXILIAR ADMINISTRATIVO">
        </div>
        <div>
          <label>Data de Admissão</label>
          <input id="admissao" type="date" value="2023-08-01">
        </div>
        <div>
          <label>CBO</label>
          <input id="cbo" type="text" value="4110-05">
        </div>
        <div>
          <label>Mês / Competência</label>
          <input id="competencia" type="text" value="Junho/2025">
        </div>
      </div>
    </section>

    <section style="margin-bottom:6px">
      <h3 style="margin:0 0 8px 0">Configurações e Salários</h3>
      <div class="grid grid-3">
        <div>
          <label>Salário Bruto (R$)</label>
          <input id="salario" type="number" step="0.01" value="2580.60">
        </div>
        <div>
          <label><span class="small">Calcular INSS automaticamente?</span></label>
          <label class="checkbox"><input id="auto_inss" type="checkbox" checked> Sim — gera linha INSS</label>
        </div>
        <div>
          <label><span class="small">Calcular FGTS automaticamente?</span></label>
          <label class="checkbox"><input id="auto_fgts" type="checkbox" checked> Sim — aparece no rodapé</label>
        </div>
      </div>
    </section>

    <section style="margin-top:12px">
      <h3 style="margin:0 0 8px 0">Itens do Holerite (adicione / remova linhas)</h3>
      <div style="margin-bottom:8px" class="row-actions">
        <button id="addRow">+ Adicionar linha</button>
        <button id="removeRow" class="ghost">- Remover última</button>
        <div style="margin-left:auto" class="small">Dica: deixe a primeira linha para o salário.</div>
      </div>

      <div style="overflow:auto">
        <table id="itensTable">
          <thead>
            <tr>
              <th style="width:80px">CÓDIGO</th>
              <th>DESCRIÇÃO</th>
              <th style="width:110px">REFERÊNCIAS</th>
              <th style="width:120px">PROVENTOS (R$)</th>
              <th style="width:120px">DESCONTOS (R$)</th>
            </tr>
          </thead>
          <tbody id="itensBody">
            <!-- linha inicial -->
          </tbody>
        </table>
      </div>
    </section>

    <section style="margin-top:12px">
      <h3 style="margin:0 0 8px 0">Colunas no PDF</h3>
      <div class="controls">
        <label class="checkbox"><input type="checkbox" id="col_codigo" checked> CÓDIGOS</label>
        <label class="checkbox"><input type="checkbox" id="col_descricao" checked> DESCRIÇÕES</label>
        <label class="checkbox"><input type="checkbox" id="col_referencia" checked> REFERÊNCIAS</label>
        <label class="checkbox"><input type="checkbox" id="col_proventos" checked> PROVENTOS</label>
        <label class="checkbox"><input type="checkbox" id="col_descontos" checked> DESCONTOS</label>
      </div>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button id="generate">Gerar Holerite (PDF)</button>
        <button id="preview" class="ghost">Visualizar Totais (console)</button>
      </div>
    </section>

    <div style="margin-top:12px" class="small">
      Próximo passo: salvar listas (empresas/funcionários/funções) em localStorage — quer que eu implemente já?
    </div>
  </div>

  <!-- libs (ordem importante) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

  <script>
    // fallback global
    window.jsPDF = window.jsPDF || (window.jspdf && window.jspdf.jsPDF);

    // utilidades
    const fmtBR = v => (isNaN(v) ? "R$ 0,00" : v.toLocaleString("pt-BR", { style:"currency", currency:"BRL" }));
    const parseNum = s => {
      if (s === null || s === undefined) return 0;
      if (typeof s === "number") return s;
      const cleaned = String(s).replace(/\./g, "").replace(",", ".").replace(/[^\d\-.]/g, "");
      return parseFloat(cleaned) || 0;
    };

    // INSS simplificado (mesmas faixas que combinamos)
    function calcularINSS(salario) {
      salario = Number(salario) || 0;
      if (salario <= 1412.00) return salario * 0.075;
      if (salario <= 2666.68) return salario * 0.09;
      if (salario <= 4000.03) return salario * 0.12;
      if (salario <= 7786.02) return salario * 0.14;
      return 7786.02 * 0.14;
    }

    // Gerenciamento de linhas (DOM)
    const itensBody = document.getElementById("itensBody");
    function createRow(data = {}) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input class="cell codigo" value="${data.codigo || ''}" /></td>
        <td><input class="cell descricao" value="${data.descricao || ''}" /></td>
        <td><input class="cell referencia" value="${data.referencia || ''}" /></td>
        <td><input class="cell provento" value="${data.provento !== undefined ? data.provento : ''}" /></td>
        <td><input class="cell desconto" value="${data.desconto !== undefined ? data.desconto : ''}" /></td>
      `;
      itensBody.appendChild(tr);
      return tr;
    }
    function addInitialRow() {
      // primeira linha padrão salário
      createRow({ codigo: "5", descricao: "Salário mensalista", referencia: "30,00", provento: document.getElementById("salario").value });
    }

    // Inicializa uma linha
    addInitialRow();

    document.getElementById("addRow").addEventListener("click", e => {
      e.preventDefault();
      createRow({});
    });
    document.getElementById("removeRow").addEventListener("click", e => {
      e.preventDefault();
      const rows = itensBody.querySelectorAll("tr");
      if (rows.length > 0) rows[rows.length - 1].remove();
    });

    // Mantém o valor do salário na primeira linha automaticamente
    document.getElementById("salario").addEventListener("input", () => {
      const first = itensBody.querySelector("tr");
      if (first) {
        const p = first.querySelector(".provento");
        if (p) p.value = document.getElementById("salario").value;
      }
    });

    // Calcular totais a partir das linhas (incluindo INSS automático se marcado)
    function calcularTotais(includeAutoINSS = true) {
      const rows = Array.from(itensBody.querySelectorAll("tr"));
      let totalProv = 0, totalDesc = 0;
      rows.forEach(r => {
        const prov = parseNum(r.querySelector(".provento").value);
        const desc = parseNum(r.querySelector(".desconto").value);
        totalProv += prov;
        totalDesc += desc;
      });

      const salario = parseNum(document.getElementById("salario").value);
      let inss = 0;
      if (includeAutoINSS && document.getElementById("auto_inss").checked) {
        inss = calcularINSS(salario);
        // only add if not already present? we still show it separately for PDF totals
      }

      const fgts = (document.getElementById("auto_fgts").checked) ? salario * 0.08 : 0;

      return {
        totalProventos: totalProv,
        totalDescontos: totalDesc + inss,
        inss,
        fgts,
        salario
      };
    }

    // GERAR PDF
    document.getElementById("generate").addEventListener("click", gerarPDF);
    document.getElementById("preview").addEventListener("click", () => {
      console.log(calcularTotais(true));
      alert("Veja os totais no console (F12).");
    });

    function gerarPDF() {
      try {
        if (!window.jsPDF) throw new Error("jsPDF não carregou. Verifique conexão CDN.");

        const { jsPDF } = window.jspdf || window;
        const doc = new jsPDF({ unit: "pt", format: "a4" });

        // Dados principais
        const empNome = document.getElementById("emp_nome").value;
        const empCei  = document.getElementById("emp_cei").value;
        const funcNome= document.getElementById("func_nome").value;
        const funcCpf = document.getElementById("func_cpf").value;
        const funcao  = document.getElementById("funcao").value;
        const admissao= document.getElementById("admissao").value;
        const cbo     = document.getElementById("cbo").value;
        const comp    = document.getElementById("competencia").value;
        const salario = parseNum(document.getElementById("salario").value);

        // construir cabeçalho
        doc.setFontSize(10);
        doc.text(empNome, 40, 28);
        doc.text(empCei, 40, 44);
        doc.setFontSize(12);
        doc.text("RECIBO DE PAGAMENTO DE SALÁRIO", 340, 28);
        doc.setFontSize(10);
        doc.text(`Referente ao mês: ${comp}`, 340, 44);

        doc.setFontSize(10);
        doc.text(`Código Nome do Colaborador`, 40, 68);
        doc.setFontSize(11);
        doc.text(funcNome, 40, 84);
        doc.text(`Função: ${funcao}`, 40, 100);
        doc.text(`CPF: ${funcCpf}   CBO: ${cbo}   Admissão: ${admissao}`, 40, 116);

        // montar cabeçalho da tabela com base em colunas marcadas
        const columns = [];
        const showCodigo = document.getElementById("col_codigo").checked;
        const showDescricao = document.getElementById("col_descricao").checked;
        const showReferencia = document.getElementById("col_referencia").checked;
        const showProventos = document.getElementById("col_proventos").checked;
        const showDescontos = document.getElementById("col_descontos").checked;

        if (showCodigo) columns.push({ title: "CÓDIGOS", dataKey: "codigo" });
        if (showDescricao) columns.push({ title: "DESCRIÇÕES", dataKey: "descricao" });
        if (showReferencia) columns.push({ title: "REFERÊNCIAS", dataKey: "referencia" });
        if (showProventos) columns.push({ title: "PROVENTOS", dataKey: "provento" });
        if (showDescontos) columns.push({ title: "DESCONTOS", dataKey: "desconto" });

        // pegar linhas do DOM e montar body
        const rowsDom = Array.from(itensBody.querySelectorAll("tr"));
        const body = rowsDom.map(r => {
          const codigo = r.querySelector(".codigo").value;
          const descricao = r.querySelector(".descricao").value;
          const referencia = r.querySelector(".referencia").value;
          const provento = parseNum(r.querySelector(".provento").value);
          const desconto = parseNum(r.querySelector(".desconto").value);
          const obj = {};
          if (showCodigo) obj.codigo = codigo || "";
          if (showDescricao) obj.descricao = descricao || "";
          if (showReferencia) obj.referencia = referencia || "";
          if (showProventos) obj.provento = provento === 0 ? "" : fmtBR(provento);
          if (showDescontos) obj.desconto = desconto === 0 ? "" : fmtBR(desconto);
          // store numeric values for totals
          obj._raw_prov = provento;
          obj._raw_desc = desconto;
          return obj;
        });

        // calculos automáticos
        const autoINSS = document.getElementById("auto_inss").checked;
        const autoFGTS = document.getElementById("auto_fgts").checked;
        const inssCalc = autoINSS ? calcularINSS(salario) : 0;
        const fgtsCalc = autoFGTS ? salario * 0.08 : 0;

        // adicionar linha INSS automaticamente (se marcado)
        if (autoINSS) {
          const inssRow = {};
          if (showCodigo) inssRow.codigo = "91005";
          if (showDescricao) inssRow.descricao = "INSS";
          if (showReferencia) inssRow.referencia = "Automático";
          if (showProventos) inssRow.provento = "";
          if (showDescontos) inssRow.desconto = fmtBR(inssCalc);
          inssRow._raw_prov = 0;
          inssRow._raw_desc = inssCalc;
          body.push(inssRow);
        }

        // montar array de linhas para autoTable (removendo chaves _raw)
        const tableBody = body.map(r => {
          const copy = {};
          columns.forEach(c => {
            copy[c.dataKey] = r[c.dataKey] || "";
          });
          // attach raw values for totals computation
          copy._raw_prov = r._raw_prov || 0;
          copy._raw_desc = r._raw_desc || 0;
          return copy;
        });

        // desenhar tabela
        if (!doc.autoTable) throw new Error("AutoTable não disponível");
        doc.autoTable({
          startY: 140,
          head: [columns.map(c => c.title)],
          body: tableBody.map(r => columns.map(c => r[c.dataKey])),
          theme: "grid",
          styles: { fontSize: 10, cellPadding: 4 },
          headStyles: { fillColor: [255,255,255], textColor: [0,0,0], halign: "center" },
          columnStyles: { 0:{cellWidth:70} }
        });

        // calcular totais a partir dos raw values
        const lastAuto = doc.lastAutoTable;
        let finalY = (lastAuto && lastAuto.finalY) ? lastAuto.finalY : 170;

        // recompute totals numerically from tableBody raw fields
        let totProv = 0, totDesc = 0;
        tableBody.forEach(r => { totProv += (r._raw_prov || 0); totDesc += (r._raw_desc || 0); });
        // totDesc já inclui INSS row if autoINSS

        // Exibir Totais (posicionar baseado em finalY)
        doc.setFontSize(10);
        doc.text("Totais:", 420, finalY + 18);
        doc.text(fmtBR(totProv), 520, finalY + 18, { align: "right" });
        doc.text(fmtBR(totDesc), 650, finalY + 18, { align: "right" });

        // Salário Líquido = proventos - descontos
        const liquido = totProv - totDesc;
        doc.setFontSize(12);
        doc.text("SALÁRIO LÍQUIDO", 420, finalY + 48);
        doc.setFontSize(14);
        doc.text(fmtBR(liquido), 650, finalY + 48, { align: "right" });

        // rodapé com bases (FGTS incluso)
        const baseIRRF = Math.max(salario - inssCalc, 0);
        doc.setFontSize(10);
        doc.text(
          `Salário base ${fmtBR(salario)}   Base INSS ${fmtBR(salario)}   Base FGTS ${fmtBR(salario)}   Valor FGTS ${fmtBR(fgtsCalc)}   Base IRRF ${fmtBR(baseIRRF)}`,
          40, finalY + 80
        );

        doc.text("Declaro ter recebido o valor líquido deste recibo.", 40, finalY + 110);
        doc.text("Assinatura do Colaborador: ____________________________________", 40, finalY + 130);

        // salvar
        doc.save(`holerite_${funcNome.replace(/\s+/g,"_")}_${comp.replace(/\s+/g,"_")}.pdf`);
      } catch (err) {
        console.error(err);
        alert("Erro ao gerar PDF: " + (err.message || err));
      }
    }
  </script>
</body>
</html>
